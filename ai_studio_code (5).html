<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>RetailPro | Premium Billing</title>
    
    <!-- LIBRARIES (CDNs) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           CSS: PREMIUM UI / UX (UNCHANGED)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --surface: #1f2937;
            --text-main: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        header { background: var(--surface); padding: 15px 20px; box-shadow: var(--shadow); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .app-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; position: relative; }
        
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--surface); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .product-item, .cart-item, .bill-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .product-item:last-child { border-bottom: none; }
        .item-info h3 { margin: 0 0 4px 0; font-size: 1rem; }
        .item-info p { margin: 0; color: var(--text-light); font-size: 0.85rem; }
        .item-action { display: flex; align-items: center; gap: 10px; }

        .btn { border: none; padding: 12px 20px; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:active { background: var(--primary-dark); transform: scale(0.98); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn-icon { background: transparent; color: var(--text-light); font-size: 1.2rem; padding: 8px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-light); }
        input, select { width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg); color: var(--text-main); font-size: 1rem; outline: none; }
        input:focus { border-color: var(--primary); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 20; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: var(--text-light); text-decoration: none; background: none; border: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; display: none; flex-direction: column; }
        #reader { width: 100%; flex: 1; }
        .scanner-controls { padding: 20px; background: black; display: flex; justify-content: center; }
        
        .bill-summary { margin-top: 20px; padding-top: 15px; border-top: 2px dashed var(--border); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .summary-row.total { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: 10px; }

        #qr-display { display: flex; flex-direction: column; align-items: center; padding: 20px; text-align: center; }
        #qrcode { margin: 20px auto; padding: 10px; background: white; border-radius: 8px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrcode img { margin: 0 auto; }

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 50; }
        .toast.show { opacity: 1; bottom: 90px; }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .fab { position: fixed; bottom: 80px; right: 20px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); font-size: 1.5rem; border: none; z-index: 15; cursor: pointer; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <h1 id="shop-title">RetailPro</h1>
        <button class="btn-icon" onclick="toggleTheme()">â—‘</button>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="app-container">

        <!-- 1. BILLING SECTION -->
        <div id="section-billing" class="section active">
            <div class="card" style="text-align: center; padding: 30px 15px;">
                <h2 style="margin-top:0;">Start Selling</h2>
                <p style="color:var(--text-light)">Scan barcodes to create a bill</p>
                <button class="btn btn-primary" onclick="startScanner('billing')">
                    ğŸ“¸ Scan Barcode
                </button>
            </div>

            <div id="cart-list">
                <!-- Cart items go here -->
            </div>

            <div id="billing-footer" class="card hidden">
                <div class="bill-summary">
                    <div class="summary-row"><span>Subtotal</span><span id="subtotal-display">â‚¹0.00</span></div>
                    <div class="summary-row">
                        <span>Discount</span>
                        <input type="number" id="discount-input" placeholder="0" style="width: 60px; padding: 4px; text-align: right;" oninput="updateCartTotals()">
                    </div>
                    <div class="summary-row total"><span>Total</span><span id="total-display">â‚¹0.00</span></div>
                </div>
                <button class="btn btn-primary" style="margin-top: 15px;" onclick="showPaymentModal()">âœ… Checkout & Pay</button>
            </div>
        </div>

        <!-- 2. PRODUCTS SECTION -->
        <div id="section-products" class="section">
            <div class="form-group">
                <input type="text" id="search-product" placeholder="ğŸ” Search products..." oninput="renderProductList()">
            </div>
            <div id="product-list">
                <!-- Products go here -->
            </div>
            <button class="fab" onclick="showAddProductModal()">+</button>
        </div>

        <!-- 3. HISTORY SECTION -->
        <div id="section-history" class="section">
            <div class="card">
                <div class="summary-row total">
                    <span>Today's Sales</span>
                    <span id="daily-total">â‚¹0.00</span>
                </div>
                <button class="btn btn-sm btn-danger" style="margin-top: 10px;" onclick="clearHistory()">Clear History</button>
            </div>
            <div id="history-list">
                <!-- History items -->
            </div>
        </div>

        <!-- 4. SETTINGS SECTION -->
        <div id="section-settings" class="section">
            <div class="card">
                <h3>Shop Settings</h3>
                <div class="form-group">
                    <label>Shop Name</label>
                    <input type="text" id="setting-shop-name" value="My Shop" onchange="saveSettings()">
                </div>
                <div class="form-group">
                    <label>Currency Symbol</label>
                    <input type="text" id="setting-currency" value="â‚¹" onchange="saveSettings()">
                </div>
            </div>
            <div class="card">
                <h3>Data Management</h3>
                <p style="font-size: 0.8rem; color: var(--text-light);">All data is stored locally on this device.</p>
                <button class="btn btn-danger" onclick="resetApp()">âš ï¸ Factory Reset App</button>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navTo('billing')">
            <div class="nav-icon">ğŸ›’</div>
            Scan & Sell
        </button>
        <button class="nav-item" onclick="navTo('products')">
            <div class="nav-icon">ğŸ“¦</div>
            Products
        </button>
        <button class="nav-item" onclick="navTo('history')">
            <div class="nav-icon">ğŸ“œ</div>
            Bills
        </button>
        <button class="nav-item" onclick="navTo('settings')">
            <div class="nav-icon">âš™ï¸</div>
            Settings
        </button>
    </nav>

    <!-- MODALS & OVERLAYS -->

    <!-- Scanner Overlay -->
    <div id="scanner-modal">
        <div style="flex:1; display:flex; align-items:center; background:#000;">
            <div id="reader"></div>
        </div>
        <div class="scanner-controls">
            <!-- FIXED: Back logic triggers browser back which closes scanner -->
            <button class="btn btn-danger" onclick="history.back()">Close Camera</button>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="modal-product" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:50; display:flex; align-items:center; justify-content:center; padding: 20px;">
        <div class="card" style="width:100%; max-width:400px; max-height: 90vh; overflow-y: auto;">
            <h3>Add/Edit Product</h3>
            <div class="form-group">
                <label>Barcode</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="prod-barcode">
                    <button class="btn btn-sm btn-primary" onclick="startScanner('product')">Scan</button>
                </div>
            </div>
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="prod-name">
            </div>
            <div class="form-group">
                <label>Price</label>
                <input type="number" id="prod-price">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                <!-- FIXED: Calls back to trigger cleanup logic -->
                <button class="btn btn-danger" onclick="history.back()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Payment/QR Modal -->
    <div id="modal-payment" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--surface); z-index:60; padding:20px; overflow-y:auto;">
        <div class="text-center" style="margin-top: 40px;">
            <h2>Payment</h2>
            <p>Show this QR to customer</p>
            <div id="qrcode"></div>
            <h1 id="pay-amount" style="color:var(--primary)"></h1>
            
            <div style="display:grid; gap:10px; margin-top:30px;">
                <button class="btn btn-primary" onclick="completeSale()">âœ… Payment Received</button>
                <button class="btn" style="background:var(--success); color:white;" onclick="shareBill()">ğŸ’¬ Share on WhatsApp</button>
                <!-- FIXED: Calls back to trigger cleanup logic -->
                <button class="btn btn-danger" onclick="history.back()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Action Successful</div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           STATE MANAGEMENT
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const STORE_KEY = 'retail_app_db_v1';
        let html5QrcodeScanner = null;
        let isScannerRunning = false; // FIXED: New flag to prevent crash
        let scanMode = null; 

        let state = {
            products: [],
            cart: [],
            invoices: [],
            settings: {
                shopName: 'My Retail Shop',
                currency: 'â‚¹',
                theme: 'light'
            }
        };

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           CORE FUNCTIONS & NAVIGATION FIX
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function init() {
            loadData();
            applyTheme();
            renderProductList();
            renderCart();
            renderHistory();
            updateShopTitle();

            // FIXED: Initialize History State for Back Button handling
            window.history.replaceState({ section: 'billing' }, '', '#billing');
            
            // FIXED: Back Button Listener (Popstate)
            window.addEventListener('popstate', (event) => {
                const s = event.state;
                
                // 1. Force Stop Scanner if back is pressed
                if (isScannerRunning) {
                    stopScannerInternal();
                }

                // 2. Hide Modals
                document.getElementById('modal-product').classList.add('hidden');
                document.getElementById('modal-payment').classList.add('hidden');

                // 3. Handle Section Navigation
                if (s && s.section) {
                    switchSection(s.section);
                } else {
                    // Default fallback
                    switchSection('billing');
                }
            });
        }

        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${sectionId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navIndex = ['billing', 'products', 'history', 'settings'].indexOf(sectionId);
            if(navIndex > -1) document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
        }

        function navTo(sectionId) {
            // FIXED: Use pushState to manage history
            // If we are already there, do nothing
            const currentSection = document.querySelector('.section.active').id.replace('section-', '');
            if(currentSection === sectionId) return;

            window.history.pushState({ section: sectionId }, '', `#${sectionId}`);
            switchSection(sectionId);
        }

        function loadData() {
            const data = localStorage.getItem(STORE_KEY);
            if (data) {
                state = JSON.parse(data);
            }
        }

        function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(state));
            renderProductList();
            renderHistory();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           PRODUCT LOGIC
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function showAddProductModal(barcode = '') {
            // FIXED: Push history state for modal
            window.history.pushState({ section: 'products', modal: 'add' }, '', '#add-product');
            
            document.getElementById('modal-product').classList.remove('hidden');
            document.getElementById('prod-barcode').value = barcode;
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-price').value = '';
            document.getElementById('prod-barcode').focus();
        }

        function saveProduct() {
            const barcode = document.getElementById('prod-barcode').value.trim();
            const name = document.getElementById('prod-name').value.trim();
            const price = parseFloat(document.getElementById('prod-price').value);

            if (!barcode || !name || isNaN(price)) {
                alert('Please fill all fields');
                return;
            }

            const existingIndex = state.products.findIndex(p => p.barcode === barcode);
            if (existingIndex > -1) {
                state.products[existingIndex] = { barcode, name, price };
            } else {
                state.products.push({ barcode, name, price });
            }

            saveData();
            
            // FIXED: Use back to close modal properly (clearing history)
            window.history.back(); 
            showToast('Product Saved!');
        }

        function renderProductList() {
            const list = document.getElementById('product-list');
            const query = document.getElementById('search-product').value.toLowerCase();
            list.innerHTML = '';

            const filtered = state.products.filter(p => p.name.toLowerCase().includes(query) || p.barcode.includes(query));

            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center" style="padding:20px; color:var(--text-light)">No products found</div>';
                return;
            }

            filtered.forEach(p => {
                const el = document.createElement('div');
                el.className = 'card product-item';
                el.innerHTML = `
                    <div class="item-info">
                        <h3>${p.name}</h3>
                        <p>#${p.barcode} | ${state.settings.currency}${p.price}</p>
                    </div>
                    <div class="item-action">
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.barcode}')">âœ•</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function deleteProduct(barcode) {
            if (confirm('Delete this product?')) {
                state.products = state.products.filter(p => p.barcode !== barcode);
                saveData();
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           SCANNER LOGIC (html5-qrcode) FIXED
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        async function startScanner(mode) {
            // FIXED: Prevent double opening
            if (isScannerRunning) return;

            // FIXED: Push history so Back button closes camera
            window.history.pushState({ mode: 'scanner' }, '', '#scanner');

            scanMode = mode;
            const modal = document.getElementById('scanner-modal');
            modal.style.display = 'flex'; // Visible BEFORE starting
            modal.classList.remove('hidden');

            // Initialize if needed
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }

            try {
                isScannerRunning = true;
                const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                
                // FIXED: Use environment (back) camera explicitly
                await html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess
                );
            } catch (err) {
                console.error("Error starting scanner", err);
                alert("Camera error: " + err);
                // If fail, go back
                window.history.back();
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (navigator.vibrate) navigator.vibrate(200);

            // FIXED: Stop scanner logic handles UI closure
            // We use history.back() to close the scanner overlay nicely
            window.history.back();

            if (scanMode === 'product') {
                // Determine if we are in modal or need to open one?
                // The history.back() closes scanner but leaves us at the previous state (Add Product Modal or Billing)
                // We need a slight delay to ensure the modal input is targeted
                setTimeout(() => {
                    const input = document.getElementById('prod-barcode');
                    if(input) input.value = decodedText;
                }, 300);
            } else if (scanMode === 'billing') {
                addToCart(decodedText);
            }
        }

        // FIXED: Internal function to actually stop the library
        async function stopScannerInternal() {
            if (html5QrcodeScanner && isScannerRunning) {
                try {
                    await html5QrcodeScanner.stop();
                    html5QrcodeScanner.clear();
                    // Do NOT nullify the instance, just clear it to reuse wrapper
                    isScannerRunning = false;
                } catch (err) {
                    console.error("Failed to stop", err);
                }
            }
            document.getElementById('scanner-modal').style.display = 'none';
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           BILLING & CART LOGIC
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function addToCart(barcode) {
            const product = state.products.find(p => p.barcode === barcode);
            
            if (!product) {
                // If product not found, ask user
                if (confirm(`Product not found (${barcode}). Add it now?`)) {
                    // Navigate to products and open modal
                    // We need to manage history carefully
                    // Replace current state to Products
                    navTo('products');
                    setTimeout(() => showAddProductModal(barcode), 100);
                }
                return;
            }

            const existing = state.cart.find(c => c.barcode === barcode);
            if (existing) {
                existing.qty++;
            } else {
                state.cart.push({ ...product, qty: 1 });
            }
            
            renderCart();
            showToast('Added to Cart');
        }

        function updateCartQty(barcode, change) {
            const item = state.cart.find(c => c.barcode === barcode);
            if (item) {
                item.qty += change;
                if (item.qty <= 0) {
                    state.cart = state.cart.filter(c => c.barcode !== barcode);
                }
                renderCart();
            }
        }

        function renderCart() {
            const container = document.getElementById('cart-list');
            const footer = document.getElementById('billing-footer');
            
            container.innerHTML = '';

            if (state.cart.length === 0) {
                container.innerHTML = '<div class="text-center" style="margin-top:50px; color:var(--text-light)">ğŸ›’ Cart is empty</div>';
                footer.classList.add('hidden');
                return;
            }

            footer.classList.remove('hidden');

            state.cart.forEach(item => {
                const el = document.createElement('div');
                el.className = 'card cart-item';
                el.innerHTML = `
                    <div class="item-info">
                        <h3>${item.name}</h3>
                        <p>${state.settings.currency}${item.price} x ${item.qty} = <b>${state.settings.currency}${item.price * item.qty}</b></p>
                    </div>
                    <div class="item-action">
                        <button class="btn btn-sm" onclick="updateCartQty('${item.barcode}', -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="btn btn-sm" onclick="updateCartQty('${item.barcode}', 1)">+</button>
                    </div>
                `;
                container.appendChild(el);
            });

            updateCartTotals();
        }

        function updateCartTotals() {
            let subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discountInput = document.getElementById('discount-input').value;
            let discount = parseFloat(discountInput) || 0;
            let total = subtotal - discount;
            if(total < 0) total = 0;

            document.getElementById('subtotal-display').textContent = state.settings.currency + subtotal.toFixed(2);
            document.getElementById('total-display').textContent = state.settings.currency + total.toFixed(2);
            
            return { subtotal, discount, total };
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           CHECKOUT & PAYMENTS (QR FIX)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function showPaymentModal() {
            const totals = updateCartTotals();
            if (totals.total <= 0) return;

            // FIXED: Add to history stack
            window.history.pushState({ section: 'billing', modal: 'payment' }, '', '#payment');

            document.getElementById('modal-payment').classList.remove('hidden');
            document.getElementById('pay-amount').textContent = state.settings.currency + totals.total.toFixed(2);
            
            // FIXED: Clear previous QR code to prevent stacking
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; 
            
            // Standard UPI String format
            const qrData = `upi://pay?pa=shop@upi&pn=${encodeURIComponent(state.settings.shopName)}&am=${totals.total.toFixed(2)}&cu=INR`;
            
            new QRCode(qrContainer, {
                text: qrData,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }

        function completeSale() {
            const totals = updateCartTotals();
            
            const invoice = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                items: [...state.cart],
                total: totals.total,
                discount: totals.discount
            };

            state.invoices.unshift(invoice); 
            state.cart = []; 
            
            saveData();
            renderCart();
            
            // FIXED: Close modal by going back in history
            window.history.back();
            
            document.getElementById('discount-input').value = '';
            
            navTo('history');
            showToast('Sale Completed! ğŸ‰');
        }

        function shareBill() {
            const totals = updateCartTotals();
            let text = `ğŸ§¾ *${state.settings.shopName}* \n\n`;
            state.cart.forEach(i => {
                text += `${i.name} x${i.qty} = ${i.price * i.qty}\n`;
            });
            text += `\nTotal: ${state.settings.currency}${totals.total}`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           HISTORY LOGIC
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            const today = new Date().toLocaleDateString();
            let dailySum = 0;

            if (state.invoices.length === 0) {
                list.innerHTML = '<div class="text-center" style="margin-top:20px; color:var(--text-light)">No sales yet</div>';
            }

            state.invoices.forEach(inv => {
                const invDate = new Date(inv.id).toLocaleDateString();
                if(invDate === today) dailySum += inv.total;

                const el = document.createElement('div');
                el.className = 'card bill-item';
                el.innerHTML = `
                    <div class="item-info">
                        <h3>Bill #${inv.id.toString().slice(-4)}</h3>
                        <p>${inv.date}</p>
                        <p style="font-size:0.8rem">${inv.items.length} items</p>
                    </div>
                    <div style="text-align:right">
                        <h3 style="color:var(--success)">${state.settings.currency}${inv.total.toFixed(2)}</h3>
                    </div>
                `;
                list.appendChild(el);
            });

            document.getElementById('daily-total').textContent = state.settings.currency + dailySum.toFixed(2);
        }

        function clearHistory() {
            if(confirm('Clear all sales history? Cannot be undone.')) {
                state.invoices = [];
                saveData();
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           SETTINGS & UTILS
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function saveSettings() {
            state.settings.shopName = document.getElementById('setting-shop-name').value;
            state.settings.currency = document.getElementById('setting-currency').value;
            saveData();
            updateShopTitle();
            renderProductList(); 
            showToast('Settings Saved');
        }

        function updateShopTitle() {
            document.getElementById('shop-title').textContent = state.settings.shopName;
            document.getElementById('setting-shop-name').value = state.settings.shopName;
            document.getElementById('setting-currency').value = state.settings.currency;
        }

        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveData();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.settings.theme);
        }

        function resetApp() {
            if(confirm('Factory Reset? This will delete ALL products and sales data.')) {
                localStorage.removeItem(STORE_KEY);
                location.reload();
            }
        }

        // Initialize App
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>